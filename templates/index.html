<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Analysis - Home</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        :root {
            --primary-blue: #007bff;
            --primary-blue-dark: #0056b3;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --text-dark: #343a40;
            --text-light: #6c757d;
            --status-red: #dc3545;
            --status-green: #28a745;
            --status-yellow: #ffc107;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--light-gray);
            color: var(--text-dark);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
        }

        .nav-brand i {
            margin-right: 0.5rem;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            margin-left: 1.5rem;
            padding: 0.5rem 0;
            transition: color 0.3s ease;
        }

        .nav-links a.active,
        .nav-links a:hover {
            color: var(--primary-blue);
            border-bottom: 2px solid var(--primary-blue);
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: var(--primary-blue-dark);
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 2rem;
        }

        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .video-feed {
            width: 100%;
            max-width: 1200px;
            height: auto;
            background-color: #000;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            display: block;
            margin: 0 auto;
        }

        #capture-view {
            max-width: 1400px;
            margin: 0 auto;
        }

        #capture-btn,
        #retake-btn {
            width: 100%;
            max-width: 400px;
            margin: 1.5rem auto;
            font-size: 1.1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        #analysis-status {
            text-align: center;
            font-weight: 500;
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
        }

        #analysis-status.success {
            color: var(--status-green);
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        #analysis-status.error {
            color: var(--status-red);
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .processed-capture-container img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--light-gray);
            display: block;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background-color: var(--light-gray);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.25rem;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .stat-card-header i {
            font-size: 1.25rem;
            margin-right: 0.75rem;
            color: var(--primary-blue);
        }

        .stat-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }

        .stat-card-value.alert {
            color: var(--status-yellow);
        }

        .stat-card-value.normal {
            color: var(--status-green);
        }

        .stat-card-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .metrics-table th,
        .metrics-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .metrics-table th {
            background-color: var(--light-gray);
            font-weight: 600;
        }

        .metrics-table td {
            color: var(--text-light);
            font-weight: 500;
        }

        .metrics-table tr:last-child td {
            border-bottom: none;
        }

        .text-light {
            color: var(--text-light);
        }

        .hidden {
            display: none;
        }

        /* Report layout - side by side: image left, report right */
        #report-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>

<body>

    <nav>
        <div class="nav-brand">
            <i class='bx bx-show-alt'></i>
            <span>CorneaSense</span>
        </div>
        <div class="nav-links">
            <a href="/" class="active">Home</a>
            <a href="/analysis">Analysis</a>
        </div>
        <a href="#" class="btn btn-primary">Export Report</a>
    </nav>

    <div class="container">

        <div id="capture-view">
            <div class="card">
                <div class="card-header">
                    <h2>Live Feed</h2>
                </div>

                <div class="center-content">
                    <img src="/video_feed" alt="Live Feed" class="video-feed" />

                    <button id="capture-btn" class="btn btn-primary">
                        <i class='bx bx-camera'></i>
                        Capture & Analyze (Press Enter)
                    </button>
                </div>

                <p id="analysis-status"></p>
            </div>
        </div>

        <div id="report-view" class="hidden">

            <div class="card">
                <div class="card-header">
                    <h2>Processed Capture</h2>
                </div>
                <div class="center-content">
                    <div class="processed-capture-container">
                        <img id="processed-image" src="" alt="Processed Capture">
                    </div>
                    <button id="retake-btn" class="btn btn-secondary">
                        <i class='bx bx-refresh'></i>
                        Retake Analysis
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Current Report</h2>
                    <span id="report-timestamp" class="text-light"></span>
                </div>

                <div class="analysis-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <i class='bx bx-unite'></i>
                            <span>Pupil Symmetry</span>
                        </div>
                        <div class="stat-card-value" id="pupil-symmetry-value"></div>
                        <div class="stat-card-details" id="pupil-symmetry-details"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <i class='bx bx-data'></i>
                            <span>Interpupillary Distance (IPD)</span>
                        </div>
                        <div class="stat-card-value" id="ipd-value"></div>
                        <div class="stat-card-details">Pixel measurement, not clinical.</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <i class='bx bxs-eyedropper'></i>
                            <span>Sclera Redness</span>
                        </div>
                        <div class="stat-card-value" id="sclera-redness-value"></div>
                        <div class="stat-card-details" id="redness-details">Indicates irritation or strain.</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <i class='bx bx-droplet'></i>
                            <span>Dryness Index</span>
                        </div>
                        <div class="stat-card-value" id="dryness-index-value"></div>
                        <div class="stat-card-details" id="dryness-details">Based on tear film reflections.</div>
                    </div>
                </div>

                <h3>Metrics Breakdown</h3>
                <div style="overflow-x: auto;">
                    <table class="metrics-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Left Eye</th>
                                <th>Right Eye</th>
                            </tr>
                        </thead>
                        <tbody id="metrics-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div><script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const captureView = document.getElementById('capture-view');
            const reportView = document.getElementById('report-view');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const statusMsg = document.getElementById('analysis-status');
            const processedImage = document.getElementById('processed-image');
            const symmetryValue = document.getElementById('pupil-symmetry-value');
            const symmetryDetails = document.getElementById('pupil-symmetry-details');
            const ipdValue = document.getElementById('ipd-value');
            const rednessValue = document.getElementById('sclera-redness-value');
            const rednessDetails = document.getElementById('redness-details');
            const drynessValue = document.getElementById('dryness-index-value');
            const drynessDetails = document.getElementById('dryness-details');
            const tableBody = document.getElementById('metrics-table-body');
            const reportTimestamp = document.getElementById('report-timestamp');

            // hide report view strictly on page load
            reportView.classList.add('hidden');
            captureView.classList.remove('hidden');

            function populateReport(data) {
                const L = data.left_eye_report, R = data.right_eye_report;
                const diff = Math.abs(L.pupil_diameter_px - R.pupil_diameter_px);
                const avg = (L.pupil_diameter_px + R.pupil_diameter_px) / 2;
                const pdiff = (avg === 0) ? 0 : (diff / avg * 100);
                if (pdiff > 15) { symmetryValue.textContent = `Asymmetrical (${pdiff.toFixed(1)}%)`; symmetryValue.className = 'stat-card-value alert'; }
                else { symmetryValue.textContent = `Symmetrical (${pdiff.toFixed(1)}%)`; symmetryValue.className = 'stat-card-value normal'; }
                symmetryDetails.textContent = `Left: ${L.pupil_diameter_px}px, Right: ${R.pupil_diameter_px}px`;
                ipdValue.textContent = `${data.interpupillary_distance_px.toFixed(0)} px`;
                const lr = L.redness_index, rr = R.redness_index;
                const lrs = lr > 1.2 ? "High" : "Normal", rrs = rr > 1.2 ? "High" : "Normal";
                rednessValue.textContent = `Left: ${lrs}, Right: ${rrs}`;
                rednessDetails.textContent = `L: ${lr.toFixed(2)}, R: ${rr.toFixed(2)}`;
                rednessValue.className = (lr > 1.2 || rr > 1.2) ? 'stat-card-value alert' : 'stat-card-value normal';
                const ld = L.dryness_index, rd = R.dryness_index;
                const lds = ld > 10 ? "High" : "Low", rds = rd > 10 ? "High" : "Low";
                drynessValue.textContent = `Left: ${lds}, Right: ${rds}`;
                drynessDetails.textContent = `L: ${ld.toFixed(2)}, R: ${rd.toFixed(2)}`;
                drynessValue.className = (ld > 10 || rd > 10) ? 'stat-card-value alert' : 'stat-card-value normal';
                reportTimestamp.textContent = `Captured: ${new Date(data.timestamp).toLocaleString()}`;
                tableBody.innerHTML = `
            <tr><td>Pupil Diameter</td><td>${L.pupil_diameter_px} px</td><td>${R.pupil_diameter_px} px</td></tr>
            <tr><td>Pupil/Iris Ratio</td><td>${L.pi_ratio}</td><td>${R.pi_ratio}</td></tr>
            <tr><td>Redness Index</td><td>${lr.toFixed(3)}</td><td>${rr.toFixed(3)}</td></tr>
            <tr><td>Dryness Index</td><td>${ld.toFixed(3)}</td><td>${rd.toFixed(3)}</td></tr>`;
            }

            function showCaptureView() {
                reportView.classList.add('hidden');
                captureView.classList.remove('hidden');
                statusMsg.style.display = 'none';
                processedImage.src = '';
            }

            async function handleCapture() {
                captureBtn.innerHTML = `<i class='bx bx-loader-alt bx-spin'></i> Analyzing...`;
                captureBtn.disabled = true;
                statusMsg.style.display = 'none';
                captureView.classList.add('hidden'); // hide live during capture
                try {
                    const res = await fetch('/capture', { method: 'POST' });
                    if (!res.ok) throw new Error(`HTTP error! ${res.status}`);
                    const r = await res.json();
                    if (r.success) {
                        populateReport(r.data);
                        processedImage.src = `${r.image_url}?t=${Date.now()}`;
                        reportView.classList.remove('hidden');
                    } else {
                        statusMsg.textContent = `❌ Analysis Failed: ${r.error}`;
                        statusMsg.className = 'error'; statusMsg.style.display = 'block';
                        captureView.classList.remove('hidden');
                    }
                } catch (e) {
                    statusMsg.textContent = `❌ Client Error: ${e.message}`;
                    statusMsg.className = 'error'; statusMsg.style.display = 'block';
                    captureView.classList.remove('hidden');
                }
                captureBtn.innerHTML = `<i class='bx bx-camera'></i> Capture & Analyze (Press Enter)`;
                captureBtn.disabled = false;
            }

            captureBtn.addEventListener('click', handleCapture);
            retakeBtn.addEventListener('click', showCaptureView);
            window.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    const visible = !captureView.classList.contains('hidden');
                    if (visible && !captureBtn.disabled) { e.preventDefault(); handleCapture(); }
                }
            });
        });
    </script>


</body>

</html>